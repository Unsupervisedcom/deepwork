# yaml-language-server: $schema=.deepwork/schemas/job.schema.json
name: commit
version: "1.0.0"
summary: "Reviews code, runs tests, lints, and commits changes. Use when ready to commit work with quality checks."
description: |
  A workflow for preparing and committing code changes with quality checks.

  The **full** workflow starts with a code review to catch issues early, runs tests until
  they pass, formats and lints code, then reviews changed files before
  committing and pushing. The review and lint steps use sub-agents to reduce
  context usage.

  Steps:
  1. review - Code review for issues, DRY opportunities, naming, and test coverage (runs in sub-agent)
  2. test - Pull latest code and run tests until they pass
  3. lint - Format and lint code (runs in sub-agent)
  4. commit_and_push - Review changes and commit/push

workflows:
  - name: full
    summary: "Full commit workflow: review, test, lint, and commit"
    steps:
      - review
      - test
      - lint
      - commit_and_push

changelog:
  - version: "1.0.0"
    changes: "Initial library version - generalized from project-specific commit workflow"

steps:
  - id: review
    name: "Code Review"
    description: "Reviews changed code for issues, DRY opportunities, naming clarity, and test coverage using a sub-agent. Use as the first step before testing."
    instructions_file: steps/review.md
    inputs: []
    outputs:
      - code_reviewed  # implicit state: code has been reviewed and issues addressed
    dependencies: []
    quality_criteria:
      - "Changed files were identified"
      - "Code was reviewed against the project's code review standards"
      - "All identified issues were addressed or documented as intentional"

  - id: test
    name: "Run Tests"
    description: "Pulls latest code and runs tests until all pass. Use after code review passes to verify changes work correctly."
    instructions_file: steps/test.md
    inputs: []
    outputs:
      - tests_passing  # implicit state: all tests pass
    dependencies:
      - review
    quality_criteria:
      - "Latest code was pulled from the branch"
      - "All tests are passing"

  - id: lint
    name: "Lint Code"
    description: "Formats and lints code using a sub-agent. Use after tests pass to ensure code style compliance."
    instructions_file: steps/lint.md
    inputs: []
    outputs:
      - code_formatted  # implicit state: code formatted and linted
    dependencies:
      - test
    quality_criteria:
      - "Code was formatted"
      - "Lint check passed with no errors"

  - id: commit_and_push
    name: "Commit and Push"
    description: "Verifies changed files, creates commit, and pushes to remote. Use after linting passes to finalize changes."
    instructions_file: steps/commit_and_push.md
    inputs: []
    outputs:
      - changes_committed  # implicit state: changes committed and pushed
    dependencies:
      - lint
    quality_criteria:
      - "Changed files were verified against expectations"
      - "Commit was created with appropriate message"
      - "Changes were pushed to remote"

{#
Template: agent-job.md.jinja
Purpose: Generates an agent definition file for Claude Code that contains the job as an agent
         with all steps as embedded skills. This replaces the meta-skill pattern.

The agent can be spawned via the Task tool or invoked as a slash command.

Template Variables:
  - job_name: string - Job identifier (e.g., "competitive_research")
  - job_summary: string - Short one-line summary of the job
  - job_description: string|null - Full description (optional)
  - total_steps: int - Number of steps in the job
  - has_workflows: bool - True if workflows are defined
  - workflows: list - Array of workflow objects:
      - name: string - Workflow identifier
      - summary: string - Short description of workflow
      - steps: list[string] - Ordered list of step IDs
      - first_step: string - First step ID to start workflow
  - standalone_steps: list - Steps not in any workflow
  - steps: list - Array of step objects with full context:
      - id: string - Step identifier
      - name: string - Human-readable step name
      - description: string - What the step does
      - instructions_content: string - Full instructions markdown
      - user_inputs: list - User parameters to gather
      - file_inputs: list - Files from previous steps
      - outputs: list - Output specifications
      - dependencies: list[string] - Required prior step IDs
      - is_standalone: bool - True if not in any workflow
      - workflow_name: string|null - Name of workflow if in one
      - workflow_step_number: int|null - Position in workflow
      - workflow_total_steps: int|null - Total steps in workflow
      - next_step: string|null - Next step in workflow
      - quality_criteria: list[string]|null - Criteria for completion
#}
{#- ==================== MACROS ==================== -#}

{#- Macro: Render output file list as comma-separated string -#}
{% macro output_files(outputs) -%}
{{ outputs | map(attribute='file') | join(', ') }}
{%- endmacro %}

{#- Macro: Render workflow as "name: summary (steps)" -#}
{% macro workflow_desc(workflow) -%}
**{{ workflow.name }}**: {{ workflow.summary }} ({{ workflow.steps | join(' â†’ ') }})
{%- endmacro %}

{#- Macro: Render step completion message -#}
{% macro completion_msg(step, job_name) -%}
{% if step.is_standalone -%}
"{{ step.id }} complete{% if step.outputs %}, outputs: {{ output_files(step.outputs) }}{% endif %}"
{%- elif step.next_step -%}
"{{ step.id }} complete{% if step.outputs %}, outputs: {{ output_files(step.outputs) }}{% endif %}"
{%- else -%}
"{{ step.workflow_name if step.workflow_name else job_name }} workflow complete{% if step.outputs %}, outputs: {{ output_files(step.outputs) }}{% endif %}"
{%- endif %}
{%- endmacro %}

{#- ==================== TEMPLATE ==================== -#}
---
name: {{ job_name }}
description: "{{ job_summary }}"
---

# {{ job_name }} Agent

{{ job_summary }}

{% if job_description %}
{{ job_description }}
{% endif %}

## Agent Overview

This agent handles the **{{ job_name }}** job with {{ total_steps }} skill{{ 's' if total_steps != 1 else '' }}.

{% if has_workflows %}
**Workflows**: {% for workflow in workflows %}{{ workflow.name }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}
{% if standalone_steps %}
**Standalone Skills**: {% for step in standalone_steps %}{{ step.id }}{% if not loop.last %}, {% endif %}{% endfor %}

{% endif %}
---

## How to Use This Agent

{% if has_workflows %}
### Workflows
{% for workflow in workflows %}
- {{ workflow_desc(workflow) }}
  - Start: `{{ workflow.first_step }}`
{% endfor %}

{% endif %}
{% if standalone_steps %}
### Standalone Skills (run anytime)
{% for step in standalone_steps %}
- **{{ step.id }}**: {{ step.description }}
{% endfor %}

{% endif %}
### All Skills
{% for step in steps %}
- `{{ step.id }}` - {{ step.description }}
{% endfor %}

---

## Agent Execution Instructions

When invoked, follow these steps:

### Step 1: Understand Intent

Parse the user's request to determine:
1. Which workflow or skill to execute
2. Any parameters or context provided
3. Whether this is a continuation of previous work

### Step 2: Check Work Branch

Before executing any skill:
1. Check current git branch
2. If on a `deepwork/{{ job_name }}-*` branch: continue using it
3. If on main/master: create new branch `deepwork/{{ job_name }}-[instance]-$(date +%Y%m%d)`

### Step 3: Execute the Appropriate Skill

Navigate to the relevant skill section below and follow its instructions.

### Step 4: Workflow Continuation

After completing a workflow step:
1. Inform the user of completion and outputs created
2. Automatically proceed to the next step if one exists
3. Continue until the workflow is complete or the user intervenes

---

## Skills
{% for step in steps %}

### Skill: {{ step.id }}

{% if step.is_standalone %}
**Type**: Standalone (can be run anytime)
{% elif step.workflow_name %}
**Type**: Workflow step {{ step.workflow_step_number }}/{{ step.workflow_total_steps }} in **{{ step.workflow_name }}**
{% endif %}

**Description**: {{ step.description }}

{% if step.dependencies %}
#### Prerequisites

Before running this skill, ensure these are complete:
{% for dep in step.dependencies %}
- `{{ dep }}`
{% endfor %}
{% endif %}

{% if step.user_inputs %}
#### Required User Input

Gather these from the user before starting:
{% for input in step.user_inputs %}
- **{{ input.name }}**: {{ input.description }}
{% endfor %}
{% endif %}

{% if step.file_inputs %}
#### Input Files

Read these files (from previous steps):
{% for input in step.file_inputs %}
- `{{ input.file }}` (from `{{ input.from_step }}`)
{% endfor %}
{% endif %}

#### Instructions

{{ step.instructions_content }}

{% if step.outputs %}
#### Outputs

Create these files/directories:
{% for output in step.outputs %}
- `{{ output.file }}`{% if output.file.endswith('/') %} (directory){% endif %}
{% if output.has_doc_spec and output.doc_spec %}

  **Doc Spec**: {{ output.doc_spec.name }}
  > {{ output.doc_spec.description }}
{% if output.doc_spec.quality_criteria %}
  **Quality Criteria**:
{% for criterion in output.doc_spec.quality_criteria %}
  - **{{ criterion.name }}**: {{ criterion.description }}
{% endfor %}
{% endif %}
{% endif %}
{% endfor %}
{% endif %}

{% if step.quality_criteria %}
#### Quality Validation

Before completing this skill, verify:
{% for criterion in step.quality_criteria %}
{{ loop.index }}. {{ criterion }}
{% endfor %}

Use a sub-agent (Haiku model) to review your work against these criteria before marking complete.
{% endif %}

#### On Completion

1. Verify outputs are created
2. Inform user: {{ completion_msg(step, job_name) }}
{% if step.next_step %}
3. **Continue to next skill**: Proceed to `{{ step.next_step }}`
{% elif not step.is_standalone %}
3. Consider creating a PR to merge the work branch
{% endif %}

---
{% endfor %}

## Guardrails

- **Never skip prerequisites**: Always verify required steps are complete before running a skill
- **Never produce partial outputs**: Complete all required outputs before marking a skill done
- **Always use the work branch**: Never commit directly to main/master
- **Follow quality criteria**: Use sub-agent review when quality criteria are specified
- **Ask for clarification**: If user intent is unclear, ask before proceeding

## Context Files

- Job definition: `.deepwork/jobs/{{ job_name }}/job.yml`
{% for step in steps %}
- {{ step.id }} instructions: `.deepwork/jobs/{{ job_name }}/{{ step.instructions_file }}`
{% endfor %}

# yaml-language-server: $schema=.deepwork/schemas/job.schema.json
name: deepwork_jobs
version: "1.4.0"
summary: "Creates and manages multi-step AI workflows. Use when defining, implementing, testing, or improving DeepWork jobs."
common_job_info_provided_to_all_steps_at_runtime: |
  Core commands for managing DeepWork jobs. These commands help you define new multi-step
  workflows, test them on real use cases, and learn from running them.

  The `new_job` workflow guides you through the full lifecycle of creating a new job:
  1. **Define**: Gather requirements through structured questions and create job.yml
  2. **Implement**: Generate step instruction files and sync slash commands
  3. **Test**: Run the workflow on a real use case, critique output, and iterate with user
  4. **Iterate**: Review what happened and improve the job definition based on learnings

  The `learn` skill reflects on conversations where DeepWork jobs were run, identifies
  confusion or inefficiencies, and improves job instructions. It also captures bespoke
  learnings specific to the current run into AGENTS.md files in the working folder.

workflows:
  - name: new_job
    summary: "Create a new DeepWork job from scratch through definition, implementation, testing, and iteration"
    steps:
      - define
      - implement
      - test
      - iterate

  - name: repair
    summary: "Clean up and migrate DeepWork configurations from prior versions"
    steps:
      - fix_settings
      - fix_jobs
      - errata

  - name: learn
    summary: "Analyze conversation history to improve job instructions and capture learnings"
    steps:
      - learn

steps:
  - id: define
    name: "Define Job Specification"
    description: "Creates a job.yml specification by gathering workflow requirements through structured questions. Use when starting a new multi-step workflow."
    instructions_file: steps/define.md
    inputs:
      - name: job_purpose
        description: "What complex task or workflow are you trying to accomplish?"
    outputs:
      job.yml:
        type: file
        description: "Definition of the job and its workflows"
        required: true
    dependencies: []
    reviews:
      - run_each: job.yml
        quality_criteria:
          "Intermediate Deliverables": "Does the job break out across the logical steps such that there are reviewable intermediate deliverables?"
          "Reviews": |
            Are there reviews defined for each step? Do particularly critical documents have their own reviews?
            Note that the reviewers do not have transcript access, so if the criteria are about the conversation,
            then add a `.deepwork/tmp/[step_summary].md` step output file so the agent has a communication channel to the reviewer.

  - id: implement
    name: "Implement Job Steps"
    description: "Generates step instruction files and syncs slash commands from the job.yml specification. Use after defining a job."
    instructions_file: steps/implement.md
    inputs:
      - file: job.yml
        from_step: define
    outputs:
      step_instruction_files:
        type: files
        description: "Instruction Markdown files for each step"
        required: true
    dependencies:
      - define
    reviews:
      - run_each: step_instruction_files
        additional_review_guidance: "Read the job.yml file in the same job directory for context on how this instruction file fits into the larger workflow."
        quality_criteria:
          "Complete Instructions": "Is the instruction file complete (no stubs or placeholders)?"
          "Specific & Actionable": "Are instructions tailored to the step's purpose, not generic?"
          "Output Examples": "Does the instruction file show what good output looks like? This can be either template examples, or negative examples of what not to do. Only required if the step has ouputs"
          "Quality Criteria": "Does the instruction file define quality criteria for its outputs?"
          "Ask Structured Questions": "If this step gathers user input, do instructions explicitly use the phrase 'ask structured questions'? If the step has no user inputs, this criterion passes automatically."
          "Prompt Engineering": "Does the instruction file follow Anthropic's best practices for prompt engineering?"
          "No Redundant Info": "Does the instruction file avoid duplicating information that belongs in the job.yml's common_job_info_provided_to_all_steps_at_runtime section? Shared context (project background, terminology, conventions) should be in common_job_info, not repeated in each step."

  - id: test
    name: "Test the New Workflow"
    description: "Tests the newly created workflow by running it on a real use case, critiquing the output, and iterating until the user is satisfied. Use after implementing a job."
    instructions_file: steps/test.md
    inputs:
      - file: job.yml
        from_step: define
      - file: step_instruction_files
        from_step: implement
    outputs:
      .deepwork/tmp/test_feedback.md:
        type: file
        description: "Feedback from testing the workflow on a real use case"
        required: true
    dependencies:
      - define
      - implement
    reviews:
      - run_each: step
        quality_criteria:
          "Workflow Invoked": "Was the new workflow actually run on the user's test case via MCP?"
          "Output Critiqued": "Did the agent identify up to 3 top issues with the output?"
          "User Feedback Gathered": "Did the agent ask the user about each issue and gather additional feedback?"
          "Corrections Made": "Were all requested corrections applied to the output?"
          "User Satisfied": "Did the user confirm the output meets their needs?"

  - id: iterate
    name: "Iterate on Workflow Design"
    description: "Reviews the test run conversation and improves the job definition based on what happened. Use after testing a newly created job."
    instructions_file: steps/iterate.md
    inputs:
      - file: job.yml
        from_step: define
      - file: step_instruction_files
        from_step: implement
      - file: .deepwork/tmp/test_feedback.md
        from_step: test
    outputs:
      job.yml:
        type: file
        description: "Updated job definition with improvements from test run"
        required: true
      step_instruction_files:
        type: files
        description: "Updated instruction Markdown files for each step"
        required: true
      scripts:
        type: files
        description: "Updated scripts to run parts of the job more efficiently"
        required: false
    dependencies:
      - define
      - implement
      - test
    reviews: []

  - id: learn
    name: "Learn from Job Execution"
    description: "Analyzes conversation history to improve job instructions and capture learnings. Use after running a job to refine it."
    instructions_file: steps/learn.md
    inputs:
      - name: job_name
        description: "Name of the job that was run (optional - will auto-detect from conversation)"
    outputs:
      AGENTS.md:
        type: file
        description: "Bespoke learnings and run-specific context for the working folder"
        required: true
      job.yml:
        type: file
        description: "Updated job definition with improvements from test run"
        required: true
      step_instruction_files:
        type: files
        description: "Updated instruction Markdown files for each step"
        required: true
      scripts:
        type: files
        description: "Updated scripts to run parts of the job more efficiently"
        required: false
    dependencies: []
    reviews:
      - run_each: step
        quality_criteria:
          "Conversation Analyzed": "Did the agent review the conversation for DeepWork job executions?"
          "Confusion Identified": "Did the agent identify points of confusion, errors, or inefficiencies?"
          "Instructions Improved": "Were job instructions updated to address identified issues?"
          "Instructions Concise": "Are instructions free of redundancy and unnecessary verbosity?"
          "Shared Content Extracted": "Is lengthy/duplicated content extracted into referenced files?"
          "Bespoke Learnings Captured": "Were run-specific learnings added to AGENTS.md?"
          "File References Used": "Do AGENTS.md entries reference other files where appropriate?"
          "Working Folder Correct": "Is AGENTS.md in the correct working folder for the job?"

  - id: fix_settings
    name: "Fix Settings Files"
    description: "Cleans up .claude/settings.json and related configuration files, removing legacy permissions, duplicate hooks, and hardcoded paths from prior DeepWork versions."
    instructions_file: steps/fix_settings.md
    inputs: []
    outputs:
      settings.json:
        type: file
        description: "Cleaned up Claude settings file with legacy permissions removed"
        required: true
    dependencies: []
    reviews:
      - run_each: step
        quality_criteria:
          "DeepWork Skills Removed": "Are `Skill(...)` entries matching jobs in `.deepwork/jobs/` removed?"
          "Non-DeepWork Skills Preserved": "Are skills NOT matching DeepWork jobs left intact?"
          "Stale make_new_job.sh Removed": "Are stale `Bash(...)` permissions referencing `.deepwork/jobs/deepwork_jobs/make_new_job.sh` removed?"
          "Rules Hooks Removed": "Are all DeepWork Rules hooks and permissions removed?"
          "Duplicate Hooks Removed": "Are duplicate hook entries consolidated or removed?"
          "Hardcoded Paths Removed": "Are user-specific hardcoded paths (like `/Users/*/...`) removed?"
          "Deprecated Commands Removed": "Are deprecated commands like `deepwork hook *` removed?"
          "Valid JSON": "Is settings.json still valid JSON after modifications?"
          "Backup Created": "Was a backup of the original settings created before modifications?"

  - id: fix_jobs
    name: "Fix Job Definitions"
    description: "Updates job.yml files and step instructions to current DeepWork format, removing deprecated fields and migrating to new structures."
    instructions_file: steps/fix_jobs.md
    inputs:
      - file: settings.json
        from_step: fix_settings
    outputs:
      job_definitions:
        type: files
        description: "Updated job.yml files and step instructions in current DeepWork format"
        required: true
      step_instruction_files:
        type: files
        description: "Updated step instruction files"
        required: true
    dependencies:
      - fix_settings
    reviews:
      - run_each: step
        additional_review_guidance: "Read the .claude/settings.json file for context on what settings were cleaned up in the prior step."
        quality_criteria:
          "Exposed Field Addressed": "Are `exposed: true` fields removed or noted as deprecated?"
          "Stop Hooks Migrated": "Are `stop_hooks` migrated to `hooks.after_agent` format?"
          "Removed Steps Cleaned": "Are references to removed steps (like `review_job_spec`) updated?"
          "Orphaned Steps Fixed": "For jobs with no workflows, is there a single workflow (named after the job) containing all steps? For jobs with existing workflows, does each orphan get its own workflow (named after the step)?"
          "Valid YAML": "Are all job.yml files valid YAML?"

  - id: errata
    name: "Clean Up Errata"
    description: "Removes obsolete files and folders from prior DeepWork versions, including old skill directories, temp files, and deprecated configurations."
    instructions_file: steps/errata.md
    outputs: {}
    inputs:
      - file: job_definitions
        from_step: fix_jobs
    dependencies:
      - fix_settings
      - fix_jobs
    reviews:
      - run_each: step
        additional_review_guidance: "Check the .deepwork/jobs/ directory and .claude/skills/ directory to verify the cleanup was done correctly."
        quality_criteria:
          "Legacy Job Skills Removed": "Are legacy skill folders for each job removed from `.claude/skills/` and `.gemini/skills/`?"
          "Deepwork Skill Preserved": "Does the `deepwork` skill folder still exist in `.claude/skills/deepwork/`?"
          "Temp Files Cleaned": "Are `.deepwork/tmp/` contents cleaned appropriately?"
          "Rules Folder Removed": "Is `.deepwork/rules/` folder backed up and removed (fully deprecated)?"
          "Rules Job Removed": "Is `.deepwork/jobs/deepwork_rules/` removed if present?"
          "Config Version Updated": "Is `.deepwork/config.yml` using current version format?"
          "DeepWork Re-installed": "Was `deepwork install` run after cleanup, and does it complete without errors?"
          "Git Status Clean": "Are changes ready to be committed (no untracked garbage files)?"

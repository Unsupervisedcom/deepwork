# yaml-language-server: $schema=.deepwork/schemas/job.schema.json
name: deepwork_jobs
version: "1.4.0"
summary: "Creates and manages multi-step AI workflows. Use when defining, implementing, testing, or improving DeepWork jobs."
common_job_info_provided_to_all_steps_at_runtime: |
  Core commands for managing DeepWork jobs. These commands help you define new multi-step
  workflows, test them on real use cases, and learn from running them.

  The `new_job` workflow guides you through the full lifecycle of creating a new job:
  1. **Define**: Gather requirements through structured questions and create job.yml
  2. **Implement**: Generate step instruction files and sync slash commands
  3. **Test**: Run the workflow on a real use case, critique output, and iterate with user
  4. **Iterate**: Review what happened and improve the job definition based on learnings

  The `learn` skill reflects on conversations where DeepWork jobs were run, identifies
  confusion or inefficiencies, and improves job instructions. It also captures bespoke
  learnings specific to the current run into AGENTS.md files in the working folder.

workflows:
  - name: new_job
    summary: "Create a new DeepWork job from scratch through definition, implementation, testing, and iteration"
    steps:
      - define
      - implement
      - test
      - iterate

  - name: repair
    summary: "Clean up and migrate DeepWork configurations from prior versions"
    steps:
      - fix_settings
      - fix_jobs
      - errata

  - name: learn
    summary: "Analyze conversation history to improve job instructions and capture learnings"
    steps:
      - learn

steps:
  - id: define
    name: "Define Job Specification"
    description: "Creates a job.yml specification by gathering workflow requirements through structured questions. Use when starting a new multi-step workflow."
    instructions_file: steps/define.md
    inputs:
      - name: job_purpose
        description: "What complex task or workflow are you trying to accomplish?"
    outputs:
      job.yml:
        type: file
        description: "Definition of the job and its workflows"
        required: true
    dependencies: []
    reviews:
      - run_each: job.yml
        quality_criteria:
          "Intermediate Deliverables": "The job breaks out across logical steps with reviewable intermediate deliverables."
          "Reviews": |
            Reviews are defined for each step. Particularly critical documents have their own reviews.
            Note that the reviewers do not have transcript access, so if the criteria are about the conversation,
            then add a `.deepwork/tmp/[step_summary].md` step output file so the agent has a communication channel to the reviewer.

  - id: implement
    name: "Implement Job Steps"
    description: "Generates step instruction files and syncs slash commands from the job.yml specification. Use after defining a job."
    instructions_file: steps/implement.md
    inputs:
      - file: job.yml
        from_step: define
    outputs:
      step_instruction_files:
        type: files
        description: "Instruction Markdown files for each step"
        required: true
    dependencies:
      - define
    reviews:
      - run_each: step_instruction_files
        additional_review_guidance: "Read the job.yml file in the same job directory for context on how this instruction file fits into the larger workflow."
        quality_criteria:
          "Complete Instructions": "The instruction file is complete (no stubs or placeholders)."
          "Specific & Actionable": "Instructions are tailored to the step's purpose, not generic."
          "Output Examples": "The instruction file shows what good output looks like. This can be either template examples, or negative examples of what not to do. Only required if the step has outputs."
          "Quality Criteria": "The instruction file defines quality criteria for its outputs."
          "Ask Structured Questions": "If this step gathers user input, instructions explicitly use the phrase 'ask structured questions'. If the step has no user inputs, this criterion passes automatically."
          "Prompt Engineering": "The instruction file follows Anthropic's best practices for prompt engineering."
          "No Redundant Info": "The instruction file avoids duplicating information that belongs in the job.yml's common_job_info_provided_to_all_steps_at_runtime section. Shared context (project background, terminology, conventions) is in common_job_info, not repeated in each step."

  - id: test
    name: "Test the New Workflow"
    description: "Tests the newly created workflow by running it on a real use case, critiquing the output, and iterating until the user is satisfied. Use after implementing a job."
    instructions_file: steps/test.md
    inputs:
      - file: job.yml
        from_step: define
      - file: step_instruction_files
        from_step: implement
    outputs:
      .deepwork/tmp/test_feedback.md:
        type: file
        description: "Feedback from testing the workflow on a real use case"
        required: true
    dependencies:
      - define
      - implement
    reviews:
      - run_each: .deepwork/tmp/test_feedback.md
        quality_criteria:
          "Test Case Documented": "The feedback file describes what test case was used and what the workflow produced."
          "Issues Identified": "The feedback file lists specific issues found during output critique."
          "Feedback Captured": "User feedback and requested corrections are documented with enough detail for the iterate step to act on."

  - id: iterate
    name: "Iterate on Workflow Design"
    description: "Reviews the test run conversation and improves the job definition based on what happened. Use after testing a newly created job."
    instructions_file: steps/iterate.md
    inputs:
      - file: job.yml
        from_step: define
      - file: step_instruction_files
        from_step: implement
      - file: .deepwork/tmp/test_feedback.md
        from_step: test
    outputs:
      job.yml:
        type: file
        description: "Updated job definition with improvements from test run"
        required: true
      step_instruction_files:
        type: files
        description: "Updated instruction Markdown files for each step"
        required: true
      scripts:
        type: files
        description: "Updated scripts to run parts of the job more efficiently"
        required: false
    dependencies:
      - define
      - implement
      - test
    reviews: []

  - id: learn
    name: "Learn from Job Execution"
    description: "Analyzes conversation history to improve job instructions and capture learnings. Use after running a job to refine it."
    instructions_file: steps/learn.md
    inputs:
      - name: job_name
        description: "Name of the job that was run (optional - will auto-detect from conversation)"
    outputs:
      AGENTS.md:
        type: file
        description: "Bespoke learnings and run-specific context for the working folder"
        required: true
      job.yml:
        type: file
        description: "Updated job definition with improvements from test run"
        required: true
      step_instruction_files:
        type: files
        description: "Updated instruction Markdown files for each step"
        required: true
      scripts:
        type: files
        description: "Updated scripts to run parts of the job more efficiently"
        required: false
    dependencies: []
    reviews:
      - run_each: step
        quality_criteria:
          "Conversation Analyzed": "The agent reviewed the conversation for DeepWork job executions."
          "Confusion Identified": "The agent identified points of confusion, errors, or inefficiencies."
          "Instructions Improved": "Job instructions were updated to address identified issues."
          "Instructions Concise": "Instructions are free of redundancy and unnecessary verbosity."
          "Shared Content Extracted": "Lengthy/duplicated content is extracted into referenced files."
          "Bespoke Learnings Captured": "Run-specific learnings were added to AGENTS.md."
          "File References Used": "AGENTS.md entries reference other files where appropriate."
          "Working Folder Correct": "AGENTS.md is in the correct working folder for the job."

  - id: fix_settings
    name: "Fix Settings Files"
    description: "Cleans up .claude/settings.json and related configuration files, removing legacy permissions, duplicate hooks, and hardcoded paths from prior DeepWork versions."
    instructions_file: steps/fix_settings.md
    inputs: []
    outputs:
      settings.json:
        type: file
        description: "Cleaned up Claude settings file with legacy permissions removed"
        required: true
    dependencies: []
    reviews:
      - run_each: step
        quality_criteria:
          "DeepWork Skills Removed": "`Skill(...)` entries matching jobs in `.deepwork/jobs/` are removed."
          "Non-DeepWork Skills Preserved": "Skills NOT matching DeepWork jobs are left intact."
          "Stale make_new_job.sh Removed": "Stale `Bash(...)` permissions referencing `.deepwork/jobs/deepwork_jobs/make_new_job.sh` are removed."
          "Rules Hooks Removed": "All DeepWork Rules hooks and permissions are removed."
          "Duplicate Hooks Removed": "Duplicate hook entries are consolidated or removed."
          "Hardcoded Paths Removed": "User-specific hardcoded paths (like `/Users/*/...`) are removed."
          "Deprecated Commands Removed": "Deprecated commands like `deepwork hook *` are removed."
          "Backup Created": "A backup of the original settings was created before modifications."

  - id: fix_jobs
    name: "Fix Job Definitions"
    description: "Updates job.yml files and step instructions to current DeepWork format, removing deprecated fields and migrating to new structures."
    instructions_file: steps/fix_jobs.md
    inputs:
      - file: settings.json
        from_step: fix_settings
    outputs:
      job_definitions:
        type: files
        description: "Updated job.yml files and step instructions in current DeepWork format"
        required: true
      step_instruction_files:
        type: files
        description: "Updated step instruction files"
        required: true
    dependencies:
      - fix_settings
    reviews:
      - run_each: step
        additional_review_guidance: "Read the .claude/settings.json file for context on what settings were cleaned up in the prior step."
        quality_criteria:
          "Exposed Field Addressed": "`exposed: true` fields are removed or noted as deprecated."
          "Stop Hooks Migrated": "`stop_hooks` are migrated to `hooks.after_agent` format."
          "Removed Steps Cleaned": "References to removed steps (like `review_job_spec`) are updated."
          "Orphaned Steps Fixed": "For jobs with no workflows, there is a single workflow (named after the job) containing all steps. For jobs with existing workflows, each orphan gets its own workflow (named after the step)."
          "Promise Lines Removed": "Step instructions do not include anything about `<promise>Quality Criteria Met</promise>`."
          "job.ymls are readable": "Calling `get_workflows` from the Deepwork tool shows all expected jobs. If any are missing, its YML is likely bad."

  - id: errata
    name: "Clean Up Errata"
    description: "Removes obsolete files and folders from prior DeepWork versions, including old skill directories, temp files, and deprecated configurations."
    instructions_file: steps/errata.md
    outputs: {}
    inputs:
      - file: job_definitions
        from_step: fix_jobs
    dependencies:
      - fix_settings
      - fix_jobs
    reviews:
      - run_each: step
        additional_review_guidance: "You should do this in a small number or turns - tee up every data request you need in your first call. Do not invoke sub-agents."
        quality_criteria:
          "Legacy Job Skills Removed": "Legacy skill folders for each job are removed from `.claude/skills/` and `.gemini/skills/`."
          "Deepwork Skill Removed": "The `deepwork` skill folder has been removed from `.claude/skills/deepwork/` and `.gemini/skills/deepwork/` (now provided by the plugin system)."
          "Rules Folder Removed": "`.deepwork/rules/` folder is gone."
          "Rules Job Removed": "`.deepwork/jobs/deepwork_rules/` is gone."
          "MCP Server Entry Removed": "The `deepwork serve` entry is removed from `.mcp.json` (or the file is deleted if empty)."

{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://deepwork.dev/schemas/job.schema.json",
  "title": "DeepWork Job Definition",
  "description": "Schema for DeepWork job.yml files. Jobs are multi-step workflows executed by AI agents.",
  "type": "object",
  "required": ["name", "version", "summary", "steps"],
  "additionalProperties": false,
  "properties": {
    "name": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*$",
      "description": "Job name (lowercase letters, numbers, underscores, must start with letter). Example: 'competitive_research'"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Semantic version (e.g., '1.0.0')"
    },
    "summary": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200,
      "description": "Brief one-line summary of what this job accomplishes. Used in skill descriptions."
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "description": "Detailed multi-line description of the job's purpose, process, and goals"
    },
    "workflows": {
      "type": "array",
      "description": "Named workflows that group steps into multi-step sequences. Workflows define execution order.",
      "items": {
        "$ref": "#/$defs/workflow"
      }
    },
    "changelog": {
      "type": "array",
      "description": "Version history documenting changes to the job definition",
      "items": {
        "$ref": "#/$defs/changelogEntry"
      }
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "description": "List of steps in the job. Each step becomes a skill/command.",
      "items": {
        "$ref": "#/$defs/step"
      }
    }
  },
  "$defs": {
    "stepId": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_]*$",
      "description": "Step identifier (lowercase letters, numbers, underscores, must start with letter)"
    },
    "workflow": {
      "type": "object",
      "required": ["name", "summary", "steps"],
      "additionalProperties": false,
      "description": "A named workflow grouping steps into a sequence",
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$",
          "description": "Workflow name (lowercase letters, numbers, underscores)"
        },
        "summary": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200,
          "description": "Brief one-line summary of what this workflow accomplishes"
        },
        "steps": {
          "type": "array",
          "minItems": 1,
          "description": "Ordered list of step entries. Each entry is either a step ID (string) or an array of step IDs for concurrent execution.",
          "items": {
            "$ref": "#/$defs/workflowStepEntry"
          }
        }
      }
    },
    "workflowStepEntry": {
      "oneOf": [
        {
          "$ref": "#/$defs/stepId"
        },
        {
          "type": "array",
          "minItems": 1,
          "description": "Array of step IDs that can be executed concurrently",
          "items": {
            "$ref": "#/$defs/stepId"
          }
        }
      ]
    },
    "changelogEntry": {
      "type": "object",
      "required": ["version", "changes"],
      "additionalProperties": false,
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Version number for this change"
        },
        "changes": {
          "type": "string",
          "minLength": 1,
          "description": "Description of changes made in this version"
        }
      }
    },
    "step": {
      "type": "object",
      "required": ["id", "name", "description", "instructions_file", "outputs"],
      "additionalProperties": false,
      "description": "A single step in a job, representing one unit of work",
      "properties": {
        "id": {
          "$ref": "#/$defs/stepId",
          "description": "Unique step identifier within this job"
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable display name for the step"
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Description of what this step does. Used in skill descriptions."
        },
        "instructions_file": {
          "type": "string",
          "minLength": 1,
          "description": "Path to instructions markdown file (relative to job directory). Example: 'steps/research.md'"
        },
        "inputs": {
          "type": "array",
          "description": "List of inputs required by this step (user parameters or files from previous steps)",
          "items": {
            "$ref": "#/$defs/stepInput"
          }
        },
        "outputs": {
          "type": "array",
          "description": "List of output files/directories produced by this step. May be empty for cleanup or validation steps.",
          "items": {
            "$ref": "#/$defs/stepOutput"
          }
        },
        "dependencies": {
          "type": "array",
          "description": "List of step IDs this step depends on. Dependencies must complete before this step runs.",
          "items": {
            "type": "string"
          },
          "default": []
        },
        "hooks": {
          "$ref": "#/$defs/hooks",
          "description": "Lifecycle hooks for validation and actions at different points in step execution"
        },
        "stop_hooks": {
          "type": "array",
          "description": "DEPRECATED: Use hooks.after_agent instead. Legacy stop hooks for quality validation loops.",
          "items": {
            "$ref": "#/$defs/hookAction"
          }
        },
        "exposed": {
          "type": "boolean",
          "description": "If true, step is user-invocable in menus/commands. If false, step is hidden (only reachable via workflows or dependencies). Default: false",
          "default": false
        },
        "hidden": {
          "type": "boolean",
          "description": "If true, step is hidden from menus. Alias for exposed: false. Default: false",
          "default": false
        },
        "quality_criteria": {
          "type": "array",
          "description": "Declarative quality criteria for evaluating step outputs. Rendered with standard evaluation framing.",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "agent": {
          "type": "string",
          "minLength": 1,
          "description": "Agent type for this step (e.g., 'general-purpose'). When set, the skill uses context forking and delegates to the specified agent type."
        }
      }
    },
    "stepInput": {
      "oneOf": [
        {
          "$ref": "#/$defs/userParameterInput"
        },
        {
          "$ref": "#/$defs/fileInput"
        }
      ]
    },
    "userParameterInput": {
      "type": "object",
      "required": ["name", "description"],
      "additionalProperties": false,
      "description": "A user-provided parameter input that will be requested at runtime",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Parameter name (used as variable name)"
        },
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Description shown to user when requesting this input"
        }
      }
    },
    "fileInput": {
      "type": "object",
      "required": ["file", "from_step"],
      "additionalProperties": false,
      "description": "A file input from a previous step's output",
      "properties": {
        "file": {
          "type": "string",
          "minLength": 1,
          "description": "File name to consume from the source step's outputs"
        },
        "from_step": {
          "type": "string",
          "minLength": 1,
          "description": "Step ID that produces this file. Must be in the dependencies list."
        }
      }
    },
    "stepOutput": {
      "oneOf": [
        {
          "type": "string",
          "minLength": 1,
          "description": "Simple output file path (backward compatible format)"
        },
        {
          "$ref": "#/$defs/outputWithDocSpec"
        }
      ]
    },
    "outputWithDocSpec": {
      "type": "object",
      "required": ["file"],
      "additionalProperties": false,
      "description": "Output file with optional document specification reference",
      "properties": {
        "file": {
          "type": "string",
          "minLength": 1,
          "description": "Output file path"
        },
        "doc_spec": {
          "type": "string",
          "pattern": "^\\.deepwork/doc_specs/[a-z][a-z0-9_-]*\\.md$",
          "description": "Path to doc spec file defining the expected document structure. Example: '.deepwork/doc_specs/report.md'"
        }
      }
    },
    "hooks": {
      "type": "object",
      "additionalProperties": false,
      "description": "Lifecycle hooks triggered at different points in step execution",
      "properties": {
        "after_agent": {
          "type": "array",
          "description": "Hooks triggered after the agent finishes. Used for quality validation loops.",
          "items": {
            "$ref": "#/$defs/hookAction"
          }
        },
        "before_tool": {
          "type": "array",
          "description": "Hooks triggered before a tool is used. Used for pre-action checks.",
          "items": {
            "$ref": "#/$defs/hookAction"
          }
        },
        "before_prompt": {
          "type": "array",
          "description": "Hooks triggered when user submits a prompt. Used for input validation.",
          "items": {
            "$ref": "#/$defs/hookAction"
          }
        }
      }
    },
    "hookAction": {
      "type": "object",
      "description": "A hook action - exactly one of: prompt (inline text), prompt_file (external file), or script (shell script)",
      "oneOf": [
        {
          "required": ["prompt"],
          "additionalProperties": false,
          "properties": {
            "prompt": {
              "type": "string",
              "minLength": 1,
              "description": "Inline prompt text for validation/action"
            }
          }
        },
        {
          "required": ["prompt_file"],
          "additionalProperties": false,
          "properties": {
            "prompt_file": {
              "type": "string",
              "minLength": 1,
              "description": "Path to prompt file (relative to job directory)"
            }
          }
        },
        {
          "required": ["script"],
          "additionalProperties": false,
          "properties": {
            "script": {
              "type": "string",
              "minLength": 1,
              "description": "Path to shell script (relative to job directory)"
            }
          }
        }
      ]
    }
  }
}

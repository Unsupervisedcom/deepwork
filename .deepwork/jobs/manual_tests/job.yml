name: manual_tests
version: "1.3.0"
summary: "Runs all manual hook/rule tests using sub-agents. Use when validating that DeepWork rules fire correctly."
description: |
  A workflow for running manual tests that validate DeepWork rules/hooks fire correctly.

  This job tests that rules fire when they should AND do not fire when they shouldn't.
  Each test is run in a SUB-AGENT (not the main agent) because:
  1. Sub-agents run in isolated contexts where file changes can be detected
  2. The Stop hook automatically evaluates rules when each sub-agent completes
  3. Sub-agents report results via MAGIC STRINGS that the main agent checks

  MAGIC STRING DETECTION: Sub-agents output:
  - "TASK_START: <task name>" - ALWAYS at the start of their response
  - "HOOK_FIRED: <rule name>" - If a DeepWork hook blocks them
  Detection logic:
  - TASK_START present + no HOOK_FIRED = hook did NOT fire
  - HOOK_FIRED present = hook fired
  - Neither present = timeout (hook blocking infinitely)

  TIMEOUT PREVENTION: All sub-agent Task calls use max_turns: 5 to prevent
  infinite hangs. If a sub-agent hits the limit (e.g., stuck in infinite block),
  treat as timeout - PASSED for "should fire" tests, FAILED for "should NOT fire".

  CRITICAL: All tests MUST run in sub-agents. The main agent MUST NOT make the file
  edits itself - it spawns sub-agents to make edits, then checks the returned magic
  strings to determine whether hooks fired.

  Steps:
  1. run_not_fire_tests - Run all "should NOT fire" tests in PARALLEL sub-agents
  2. run_fire_tests - Run all "should fire" tests in SERIAL sub-agents with reverts between

  Test types covered:
  - Trigger/Safety mode
  - Set mode (bidirectional)
  - Pair mode (directional)
  - Command action
  - Multi safety
  - Infinite block (prompt and command)
  - Created mode (new files only)

changelog:
  - version: "1.3.0"
    changes: "Major overhaul: Added TASK_START/HOOK_FIRED magic string detection; fixed all file names in prompts; added max_turns: 5 timeout; use deepwork rules clear_queue CLI"
  - version: "1.2.1"
    changes: "Fixed incomplete revert - now uses git reset HEAD to unstage files (rules_check stages with git add -A)"
  - version: "1.2.0"
    changes: "Added early termination on 2 test failures; emphasized mandatory file revert and queue clear after each step"
  - version: "1.1.0"
    changes: "Added rules queue clearing between tests to prevent anti-infinite-loop mechanism from blocking tests"
  - version: "1.0.0"
    changes: "Initial job creation - tests run in sub-agents to observe automatic hook firing"

steps:
  - id: run_not_fire_tests
    name: "Run Should-NOT-Fire Tests"
    description: "Runs all 'should NOT fire' tests in parallel sub-agents. Use to verify rules don't fire when safety conditions are met."
    instructions_file: steps/run_not_fire_tests.md
    inputs: []
    outputs:
      - not_fire_results  # implicit state: all "should NOT fire" tests passed
    dependencies: []
    quality_criteria:
      - "**Sub-Agents Used**: Did the main agent spawn sub-agents (using the Task tool) to make the file edits? The main agent must NOT edit the test files directly."
      - "**Parallel Execution**: Were multiple sub-agents launched in parallel (in a single message with multiple Task tool calls)?"
      - "**Task Parameters**: Did each Task call include `model: \"haiku\"` and `max_turns: 5`?"
      - "**Magic String Detection**: Did the main agent check each sub-agent's response for `TASK_START:` (present) and absence of `HOOK_FIRED:`? The agent must NOT manually run rules_check."
      - "**Early Termination**: If 2 tests failed, did testing halt immediately with results reported?"
      - "**Git Reverted**: Were changes reverted and queue cleared after tests completed (or after early termination) using `git reset HEAD manual_tests/ && git checkout -- manual_tests/` and `deepwork rules clear_queue`?"

  - id: run_fire_tests
    name: "Run Should-Fire Tests"
    description: "Runs all 'should fire' tests serially with git reverts between each. Use after NOT-fire tests to verify rules fire correctly."
    instructions_file: steps/run_fire_tests.md
    inputs:
      - file: not_fire_results
        from_step: run_not_fire_tests
    outputs:
      - fire_results  # implicit state: all "should fire" tests passed
    dependencies:
      - run_not_fire_tests
    quality_criteria:
      - "**Sub-Agents Used**: Did the main agent spawn a sub-agent (using the Task tool) for EACH test? The main agent must NOT edit the test files directly."
      - "**Serial Execution**: Were sub-agents launched ONE AT A TIME (not in parallel) to prevent cross-contamination?"
      - "**Task Parameters**: Did each Task call include `model: \"haiku\"` and `max_turns: 5`?"
      - "**Magic String Detection**: Did the main agent check each sub-agent's response for `HOOK_FIRED:` (present) or timeout (neither TASK_START nor HOOK_FIRED)? The agent must NOT manually run rules_check."
      - "**Git Reverted Between Tests**: Was `git reset HEAD manual_tests/ && git checkout -- manual_tests/` and `deepwork rules clear_queue` run after each test to revert files and prevent cross-contamination?"
      - "**Early Termination**: If 2 tests failed, did testing halt immediately with results reported?"
      - "**Results Recorded**: Did the main agent track pass/fail status for each test case?"

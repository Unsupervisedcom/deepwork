name: commit
version: "1.0.0"
summary: "Run tests, lint, and commit code changes"
description: |
  A workflow for preparing and committing code changes with quality checks.

  This job runs tests until they pass, formats and lints code with ruff,
  then reviews changed files before committing and pushing. The lint step
  uses a sub-agent to reduce context usage.

  Steps:
  1. test - Pull latest code and run tests until they pass
  2. lint - Format and lint code with ruff (runs in sub-agent)
  3. commit_and_push - Review changes and commit/push

changelog:
  - version: "1.0.0"
    changes: "Initial job creation"

steps:
  - id: test
    name: "Run Tests"
    description: "Pull latest code and run the test suite until all tests pass"
    instructions_file: steps/test.md
    inputs:
      - name: test_command
        description: "Test command to run (optional - will auto-detect if not provided)"
    outputs:
      - test_results.md
    dependencies: []
    hooks:
      after_agent:
        - prompt: |
            Verify the tests are passing:
            1. Latest code was pulled from the branch
            2. All tests completed successfully
            3. No test failures or errors remain
            4. Test output shows passing status
            If ALL criteria are met, include `<promise>✓ Quality Criteria Met</promise>`.

  - id: lint
    name: "Lint Code"
    description: "Format and lint code with ruff using a sub-agent"
    instructions_file: steps/lint.md
    inputs:
      - file: test_results.md
        from_step: test
    outputs:
      - lint_results.md
    dependencies:
      - test
    hooks:
      after_agent:
        - prompt: |
            Verify the linting is complete:
            1. ruff format was run successfully
            2. ruff check was run successfully (with --fix)
            3. No remaining lint errors
            If ALL criteria are met, include `<promise>✓ Quality Criteria Met</promise>`.

  - id: commit_and_push
    name: "Commit and Push"
    description: "Review changed files, commit, and push to remote"
    instructions_file: steps/commit_and_push.md
    inputs:
      - file: lint_results.md
        from_step: lint
    outputs:
      - commit_summary.md
    dependencies:
      - lint
    hooks:
      after_agent:
        - prompt: |
            Verify the commit is ready:
            1. Changed files list was reviewed with user
            2. User confirmed the files match expectations
            3. Commit was created with appropriate message
            4. Changes were pushed to remote
            If ALL criteria are met, include `<promise>✓ Quality Criteria Met</promise>`.

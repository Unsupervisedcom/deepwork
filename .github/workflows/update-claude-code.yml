name: Update Claude Code

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Check for new claude-code version
        id: check-version
        run: |
          # Get current version from package.nix
          CURRENT_VERSION=$(grep 'version = "' nix/claude-code/package.nix | head -1 | sed 's/.*version = "\([^"]*\)".*/\1/')
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Get latest version from npm
          LATEST_VERSION=$(npm view @anthropic-ai/claude-code version 2>/dev/null || echo "")
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

          # Check if update is needed
          if [ -z "$LATEST_VERSION" ]; then
            echo "Failed to fetch latest version from npm"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_VERSION" = "$LATEST_VERSION" ]; then
            echo "Already at latest version: $CURRENT_VERSION"
            echo "needs_update=false" >> $GITHUB_OUTPUT
          else
            echo "Update available: $CURRENT_VERSION -> $LATEST_VERSION"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Update claude-code package
        if: steps.check-version.outputs.needs_update == 'true'
        run: |
          # Run the update script (syncs from nixpkgs)
          ./nix/claude-code/update.sh

      - name: Update flake.lock
        if: steps.check-version.outputs.needs_update == 'true'
        run: |
          nix flake update

      - name: Verify build
        if: steps.check-version.outputs.needs_update == 'true'
        run: |
          # Test that the package builds successfully
          nix develop --command claude --version

      - name: Create Pull Request
        if: steps.check-version.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update claude-code to ${{ steps.check-version.outputs.latest_version }}"
          title: "chore(deps): update claude-code to ${{ steps.check-version.outputs.latest_version }}"
          body: |
            Automated update of claude-code package.

            **Changes:**
            - claude-code: ${{ steps.check-version.outputs.current_version }} â†’ ${{ steps.check-version.outputs.latest_version }}
            - Updated flake.lock

            **Verification:**
            - Package builds successfully
            - `claude --version` returns expected version

            ---
            *This PR was automatically created by the update-claude-code workflow.*
          branch: update-claude-code
          delete-branch: true
          labels: |
            dependencies
            automated
